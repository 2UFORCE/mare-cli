// ... (após receber a aiResponseText da API)

console.log('--- RESPOSTA BRUTA DA API ---');
console.log(aiResponseText);
console.log('--- FIM DA RESPOSTA ---');

let jsonString = aiResponseText;

// Lógica de limpeza robusta:
// Tenta encontrar o conteúdo entre { e } ou [ e ]
const jsonMatch = jsonString.match(/\{[\s\S]*\}|\[[\s\S]*\]/);

if (jsonMatch) {
  jsonString = jsonMatch;
} else {
  // Se não encontrar nenhum JSON, lança um erro claro
  throw new Error("Nenhum conteúdo JSON válido encontrado na resposta da API.");
}

try {
  const lessonJson = JSON.parse(jsonString);
  // Retorna a resposta de sucesso
  return {
    statusCode: 200,
    body: JSON.stringify(lessonJson),
  };
} catch (error) {
  console.error("Erro ao fazer o parse do JSON extraído:", error);
  console.error("Texto que falhou no parse:", jsonString);
  throw new Error("A resposta da API parecia JSON, mas continha um erro de sintaxe.");
}

// O antigo bloco try...catch pode ser substituído por este.